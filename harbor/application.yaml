apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: harbor
  namespace: argocd
spec:
  project: default

  # Multi-source: 1) Git for values.yaml, 2) Helm repo for chart
  sources:
    # 1️⃣ Git repo containing values.yaml
    - repoURL: https://github.com/linusdahlbergpriv/k8s-public.git
      targetRevision: main
      path: harbor
      ref: values 

    # 2️⃣ Official Harbor Helm chart
    - repoURL: https://helm.goharbor.io
      chart: harbor
      targetRevision: 1.14.0
      helm:
        valueFiles:
          - $values/values.yaml   # This tells Argo CD to use your Git values.yaml

  destination:
    server: https://kubernetes.default.svc
    namespace: harbor

  syncPolicy:
    syncOptions:
      - CreateNamespace=true

    # Optional: selfHeal only if you want Argo CD to reconcile drift
    # automated:
    #   selfHeal: true

  # Optional: ignore Secrets to avoid constant OutOfSync due to Harbor mutating them
  ignoreDifferences:
    - kind: Secret
      jsonPointers:
        - /data
